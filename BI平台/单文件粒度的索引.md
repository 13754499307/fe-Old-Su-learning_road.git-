# ES索引:单文件粒度

#### es索引按文件粒度进行创建

##### 1. 存在问题

- 定义未知字段: 使用MySQL存在已定义字段, 并同时创建es索引.这两步操作应实现原子性. 
  - 使用`redlock`上锁, 锁的key应保证唯一, 可以使用: `字段名 + 文件名 + timestamp`, 并进行某种碰撞概率较低的编码方式编码作为全局唯一`key`.
  - 在上述key中, 写入一个标志位`flag`用来判断逻辑的成功与否. 
  - 使用python的`try-except-finally`进行, 其中`finally`中首先获取标志位`flag`, 来判断两步更新是否成功, 如果失败, 则执行回滚操作;如果成功, 则进行后续逻辑.